(()=>{var e={};e.id=326,e.ids=[326],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1997:e=>{"use strict";e.exports=require("punycode")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},5892:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>g,routeModule:()=>c,serverHooks:()=>x,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>l});var s={};t.r(s),t.d(s,{POST:()=>d});var o=t(6559),a=t(8088),i=t(7719),n=t(2190),u=t(1223),p=t(4999);async function d(e){try{let r=(0,u.createRouteHandlerClient)({cookies:p.UL}),{data:{session:t}}=await r.auth.getSession();if(!t)return n.NextResponse.json({error:"N\xe3o autorizado. Fa\xe7a login para continuar."},{status:401});let{data:s,error:o}=await r.from("brands").select("id, name").eq("id",t.user.id).single();if(o||!s)return n.NextResponse.json({error:"Apenas marcas podem resgatar cupons."},{status:403});let{code:a,location:i,value:d}=await e.json();if(!a)return n.NextResponse.json({error:"C\xf3digo do cupom \xe9 obrigat\xf3rio."},{status:400});let{data:c,error:m}=await r.from("coupons").select(`
        *,
        participations:participation_id (
          creator_id,
          campaign_id,
          campaigns:campaign_id (
            title,
            brand_id
          )
        )
      `).eq("code",a).eq("status","active").single();if(m||!c)return n.NextResponse.json({error:"Cupom inv\xe1lido ou expirado."},{status:404});if(c.participations.campaigns.brand_id!==t.user.id)return n.NextResponse.json({error:"Este cupom n\xe3o pertence a uma campanha da sua marca."},{status:403});let{error:l}=await r.from("coupons").update({status:"used",used_at:new Date().toISOString(),used_by:s.name}).eq("id",c.id);if(l)return console.error("Erro ao atualizar status do cupom:",l),n.NextResponse.json({error:"Erro ao resgatar cupom. Por favor, tente novamente."},{status:500});let{data:x,error:g}=await r.from("coupon_redemptions").insert([{coupon_id:c.id,location:i||s.name,value:d||c.value,metadata:{redeemed_by:t.user.id,redeemed_by_name:s.name}}]).select().single();if(g)return console.error("Erro ao criar registro de resgate:",g),n.NextResponse.json({error:"Erro ao registrar resgate. Por favor, tente novamente."},{status:500});return d&&await r.from("participations").update({earnings:r.rpc("increment",{x:d})}).eq("id",c.participation_id),await r.from("notifications").insert([{user_id:c.participations.creator_id,title:"Cupom resgatado",content:`Seu cupom "${a}" foi resgatado por ${s.name}.`,type:"coupon_redeemed",is_read:!1,metadata:{coupon_id:c.id,brand_id:t.user.id,brand_name:s.name,value:d||c.value}}]),n.NextResponse.json({success:!0,redemption:{id:x.id,coupon_code:a,redeemed_at:x.redeemed_at,value:x.value}})}catch(e){return console.error("Erro interno:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/coupons/redeem/route",pathname:"/api/coupons/redeem",filename:"route",bundlePath:"app/api/coupons/redeem/route"},resolvedPagePath:"/Users/luizgustavovincenzi/ai-projects/CriaCore/criacore-1/src/app/api/coupons/redeem/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:l,serverHooks:x}=c;function g(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:l})}},6487:()=>{},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[524,80],()=>t(5892));module.exports=s})();