"use strict";(()=>{var e={};e.id=893,e.ids=[893],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},5516:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>x,originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>_});var o={};t.r(o),t.d(o,{POST:()=>p});var a=t(5419),i=t(9108),s=t(9678),n=t(8070),u=t(7699),d=t(2455);async function p(e){try{let r=(0,u.createRouteHandlerClient)({cookies:d.cookies}),{data:{session:t}}=await r.auth.getSession();if(!t)return n.Z.json({error:"N\xe3o autorizado. Fa\xe7a login para continuar."},{status:401});let{data:o,error:a}=await r.from("brands").select("id, name").eq("id",t.user.id).single();if(a||!o)return n.Z.json({error:"Apenas marcas podem resgatar cupons."},{status:403});let{code:i,location:s,value:p}=await e.json();if(!i)return n.Z.json({error:"C\xf3digo do cupom \xe9 obrigat\xf3rio."},{status:400});let{data:c,error:m}=await r.from("coupons").select(`
        *,
        participations:participation_id (
          creator_id,
          campaign_id,
          campaigns:campaign_id (
            title,
            brand_id
          )
        )
      `).eq("code",i).eq("status","active").single();if(m||!c)return n.Z.json({error:"Cupom inv\xe1lido ou expirado."},{status:404});if(c.participations.campaigns.brand_id!==t.user.id)return n.Z.json({error:"Este cupom n\xe3o pertence a uma campanha da sua marca."},{status:403});let{error:l}=await r.from("coupons").update({status:"used",used_at:new Date().toISOString(),used_by:o.name}).eq("id",c.id);if(l)return console.error("Erro ao atualizar status do cupom:",l),n.Z.json({error:"Erro ao resgatar cupom. Por favor, tente novamente."},{status:500});let{data:g,error:x}=await r.from("coupon_redemptions").insert([{coupon_id:c.id,location:s||o.name,value:p||c.value,metadata:{redeemed_by:t.user.id,redeemed_by_name:o.name}}]).select().single();if(x)return console.error("Erro ao criar registro de resgate:",x),n.Z.json({error:"Erro ao registrar resgate. Por favor, tente novamente."},{status:500});return p&&await r.from("participations").update({earnings:r.rpc("increment",{x:p})}).eq("id",c.participation_id),await r.from("notifications").insert([{user_id:c.participations.creator_id,title:"Cupom resgatado",content:`Seu cupom "${i}" foi resgatado por ${o.name}.`,type:"coupon_redeemed",is_read:!1,metadata:{coupon_id:c.id,brand_id:t.user.id,brand_name:o.name,value:p||c.value}}]),n.Z.json({success:!0,redemption:{id:g.id,coupon_code:i,redeemed_at:g.redeemed_at,value:g.value}})}catch(e){return console.error("Erro interno:",e),n.Z.json({error:"Erro interno do servidor"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/coupons/redeem/route",pathname:"/api/coupons/redeem",filename:"route",bundlePath:"app/api/coupons/redeem/route"},resolvedPagePath:"/Users/luizgustavovincenzi/ai-projects/CriaCore/criacore-1/src/app/api/coupons/redeem/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:l,serverHooks:g,headerHooks:x,staticGenerationBailout:_}=c,f="/api/coupons/redeem/route";function v(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:l})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[225,890,280],()=>t(5516));module.exports=o})();